<div class="d-flex flex-column gap-3">
	{% for publication in publications %}
	<div class="card position-static">
		<div class="card-header d-flex align-content-center" style="justify-content: space-between;">
			{% if current_user == publication.author_publication %}
			<div class=" d-flex gap-2 align-items-center">
				<img class="round" src="{{url_for('utils_blueprint.media_files', filename='avatar/' + publication.author_publication.avatar)}}" alt="user" style="width: 30px; border-radius: 50%;">
				<a href="{{url_for('user_blueprint.profile')}}" class="m-0 fw-bold">{{ publication.author_publication.username }}</a>
			</div>
			{% else %}
			<div class="d-flex gap-2">
				<img class="round" src="{{url_for('utils_blueprint.media_files', filename='avatar/' + publication.author_publication.avatar)}}" alt="user" style="width: 30px; border-radius: 50%;">
				<div>
					<a href="{{url_for('user_blueprint.user_profile', user_id=publication.author_publication.id)}}" class="m-0 fw-bold">{{ publication.author_publication.username }}</a>
					<form method="POST" action="
					{% if current_user.is_subscription(publication.author_publication) %}
					{{ url_for('subscription_blueprint.un_subscription_user', user_id=publication.author_publication.id) }}
					{% else %}
					{{ url_for('subscription_blueprint.subscription_user', user_id=publication.author_publication.id) }}
					{% endif %}">
						{% if current_user.is_subscription(publication.author_publication) %}
						<button type="submit" class="btn btn-link m-0 p-0 text-decoration-none" style="font-size: 14px; color: #dc3545;">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
						{% else %}
						<button type="submit" class="btn btn-link m-0 p-0 text-decoration-none" style="font-size: 14px; color: #007bff;">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
						{% endif %}
					</form>
				</div>
			</div>
			{% endif %}
			{% if current_user == publication.author_publication %}
			<div>
				<a class="d-flex align-items-center text-white text-decoration-none" data-bs-toggle="dropdown">
					<i class="bi bi-three-dots-vertical"></i>
				</a>
				<ul class="dropdown-menu">
					<li><a class="dropdown-item" href="{{ url_for('publication_blueprint.publication_update', id_publication=publication.id)}}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a></li>
					<li><a class="dropdown-item" href="{{ url_for('publication_blueprint.publication_delete', id_publication=publication.id)}}">–£–¥–∞–ª–∏—Ç—å</a></li>
				</ul>
			</div>
			{% endif %}
		</div>
		<div class="card-body">
			{% if publication.image %}
			<img style="width: 100%;" src="{{ url_for('utils_blueprint.media_files', filename='publication_image/' + publication.image) }}" alt="{{publication.image}}">
			{% endif %}

			{% if publication.video %}
			<hr>
			<div class="video-container">
				<video id="video{{ publication.id }}" class="publication-video" style="width: 100%;" muted>
					<source src="{{ url_for('utils_blueprint.media_files', filename='publication_video/' + publication.video) }}">
				</video>
				<button id="playPauseButton{{ publication.id }}" class="mute-btn" style="background: rgba(0, 0, 0, 0.5); border: none; padding: 5px 10px;">‚ñ∂Ô∏è</button>
				<button id="muteButton{{ publication.id }}" class="mute-btn" style="background: rgba(0, 0, 0, 0.5); border: none; padding: 5px 10px;">üîá</button>
			</div>
			<hr>
			{% endif %}
		<a href="{{url_for('publication_blueprint.publication_view', id_publication=publication.id)}}">
			<p class="card-title">{{ publication.title }}</p>
			{% if publication.content %}
				<p class="card-text">{{ publication.content.replace('\n', '<br>') | truncate(300, False) }}</p>
			{% endif %}
		</a>
		</div>
		<div class="card-footer d-flex gap-3 align-items-center">
			<form action="{{ url_for('like_blueprint.like', publication_id=publication.id) }}" method="POST">
				{% if publication.id in user_likes %}
				<button type="submit" class="unlike btn btn-outline-danger">
					<i class="bi bi-heart-fill"></i>
					<span>{{ publication.like_count() }}</span>
				</button>
				{% else %}
				<button type="submit" class="btn btn-outline-secondary like">
					<i class="bi bi-heart"></i>
					<span>{{ publication.like_count() }}</span>
				</button>
				{% endif %}
			</form>
			<button class="comment btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#commentForm{{ publication.id }}">
				<i class="bi bi-chat-dots"></i>
				<span>{{ publication.comment_count() }}</span>
			</button>
			<button class="btn btn-outline-secondary" type="button">
				<i class="bi bi-send"></i>
			</button>
			<span class="p-2" style="border-radius: 0.375rem; color: #6c757d; border: 1px solid #6c757d;">
				<i class="bi bi-eye"></i>
				<span style="font-size: 1rem; font-weight: 400;">{{ publication.view_count() }}</span>
			</span>
		</div>
		<div class="collapse mt-3" id="commentForm{{ publication.id }}">
			<div class="card card-body">
				<div style="max-height: 400px; overflow-y: auto;">
					{% if publication_comment[publication.id] %}
						{% for comment in publication_comment[publication.id] %}
							<p><strong>{{ comment.author_comment.username }}</strong></p>
							<p>{{ comment.content }}</p>
							<p class="m-0" style="font-size: small;">{{comment.created_at.strftime('%d-%m-%Y %H:%M:%S') }}</p>
							<hr>
						{% endfor %}
					{% else %}
					<h5 class="p-0 m-0">–û—Å—Ç–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ</h5>
					{% endif %}
				</div>
				<hr>
				<form method="post" action="{{ url_for('comment_blueprint.comment', publication_id=publication.id) }}">
					{{ form.csrf_token }}
					{{ form.content.label(class="m-1") }}
					<div class="d-flex">
						{{ form.content(class="form-control me-2", placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π") }}
						{{ form.submit(class="btn btn-success w-25") }}
					</div>
				</form>
			</div>
		</div>
	</div>
	{% endfor %}
</div>

<script>
	document.addEventListener("DOMContentLoaded", function () {
        const videos = document.querySelectorAll('.publication-video');

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –¥–ª—è –≤–∏–¥–µ–æ
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target;
                const videoId = video.id.replace('video', '');
                const playPauseButton = document.querySelector(`#playPauseButton${videoId}`);
                const muteButton = document.querySelector(`#muteButton${videoId}`);

                if (entry.isIntersecting) {
                    video.play(); // –í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è, –µ—Å–ª–∏ –æ–Ω–æ –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞
                    playPauseButton.textContent = '‚è∏Ô∏è'; // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –ø–∞—É–∑—É
                } else {
                    video.pause(); // –°—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
                    playPauseButton.textContent = '‚ñ∂Ô∏è'; // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –ø–ª–µ–π
                }

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º –ø–æ –∫–Ω–æ–ø–∫–µ
                muteButton.addEventListener('click', function () {
                    if (video.muted) {
                        video.muted = false;
                        muteButton.textContent = 'üîä'; // –ò–∑–º–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –≤–∫–ª—é—á–µ–Ω–Ω—ã–π –∑–≤—É–∫
                    } else {
                        video.muted = true;
                        muteButton.textContent = 'üîá'; // –ò–∑–º–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–π –∑–≤—É–∫
                    }
                });

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º/–ø–∞—É–∑–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
                playPauseButton.addEventListener('click', function () {
                    if (video.paused) {
                        video.play();
                        playPauseButton.textContent = '‚è∏Ô∏è'; // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –ø–∞—É–∑—É
                    } else {
                        video.pause();
                        playPauseButton.textContent = '‚ñ∂Ô∏è'; // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –ø–ª–µ–π
                    }
                });
            });
        }, { threshold: 1 }); // –í–∏–¥–µ–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –Ω–∞ 50% –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞

        // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∫–∞–∂–¥—ã–º –≤–∏–¥–µ–æ
        videos.forEach(video => {
            observer.observe(video);
        });
    });
</script>

